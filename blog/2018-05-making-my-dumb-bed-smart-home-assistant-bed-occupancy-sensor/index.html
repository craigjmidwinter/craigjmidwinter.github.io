<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/assets/blog/IMG_20180518_174346.jpg"/><link rel="stylesheet" href="/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/craigjmidwinter.github.io/_next/static/chunks/webpack-05a4c90833827c02.js"/><script src="/craigjmidwinter.github.io/_next/static/chunks/4bd1b696-d31891ed15a5103e.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/517-2e9372f9ab95c04e.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/main-app-3b8a8eba0304deb0.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/285-46291424471f6717.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/app/layout-7d366822714c55bb.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/ee560e2c-c5c28398d0153d35.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/977-4f350745d400d589.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/173-52b2b489d82616e2.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/590-97f4dc9b90039a27.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/app/blog/%5Bslug%5D/page-ac15a53f2a627631.js" async=""></script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><title>Craig Midwinter - Personal Website</title><meta name="description" content="Welcome to my personal website. Check out my resume, GitHub, LinkedIn, podcast, and blog posts."/><link rel="icon" href="/craigjmidwinter.github.io/favicon.ico" type="image/x-icon" sizes="16x16"/><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet"/><script src="/craigjmidwinter.github.io/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script><style data-styled="" data-styled-version="6.1.15">.cMMXFN{background:rgba(0, 0, 20, 0.9);padding:1.5rem 2rem;border-bottom:2px solid #0ff;box-shadow:0 0 25px rgba(0, 255, 255, 0.3);position:relative;font-family:'Press Start 2P',monospace;backdrop-filter:blur(5px);}/*!sc*/
data-styled.g1[id="sc-FEMpB"]{content:"cMMXFN,"}/*!sc*/
.kIaxle{list-style:none;display:flex;gap:2rem;margin:0;padding:0;justify-content:center;}/*!sc*/
data-styled.g2[id="sc-gjcoXW"]{content:"kIaxle,"}/*!sc*/
.iGNEod{position:relative;}/*!sc*/
.iGNEod a{color:#0ff;text-decoration:none;padding:0.5rem 1rem;transition:all 0.3s ease;position:relative;}/*!sc*/
.iGNEod a:hover{color:#f0f;animation:cjwSKm 0.3s infinite;}/*!sc*/
.iGNEod a:hover::before{content:">";position:absolute;left:-1.2em;filter:drop-shadow(0 0 2px #f0f);}/*!sc*/
.iGNEod a:hover::after{content:"_";margin-left:0.5rem;}/*!sc*/
data-styled.g3[id="sc-dVBluf"]{content:"iGNEod,"}/*!sc*/
@keyframes cjwSKm{0%{text-shadow:2px 2px #0ff,-2px -2px #f0f;}25%{text-shadow:-2px 2px #0ff,2px -2px #f0f;}50%{text-shadow:2px -2px #0ff,-2px 2px #f0f;}75%{text-shadow:-2px -2px #0ff,2px 2px #f0f;}100%{text-shadow:2px 2px #0ff,-2px -2px #f0f;}}/*!sc*/
data-styled.g11[id="sc-keyframes-cjwSKm"]{content:"cjwSKm,"}/*!sc*/
.jJIuNk{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:-2;}/*!sc*/
data-styled.g12[id="sc-cMqPwU"]{content:"jJIuNk,"}/*!sc*/
.hNzkKj{max-width:800px;margin:2rem auto;padding:2rem;background:#000;color:#0f0;font-family:'IBM Plex Mono',monospace;line-height:1.6;border:2px solid #0f0;box-shadow:0 0 20px rgba(0, 255, 0, 0.5);position:relative;overflow:hidden;}/*!sc*/
data-styled.g13[id="sc-jUkaYT"]{content:"hNzkKj,"}/*!sc*/
.dYLfrY{background:rgba(0, 0, 0, 0.7);color:#ff0;border:1px solid #f0f;padding:1rem;margin-bottom:1rem;text-align:center;font-size:0.85rem;line-height:1.4;}/*!sc*/
.dYLfrY strong{color:#f0f;}/*!sc*/
data-styled.g14[id="sc-deSjom"]{content:"dYLfrY,"}/*!sc*/
.goaCnt{margin-bottom:1rem;}/*!sc*/
.goaCnt h1{font-size:1.5rem;margin-bottom:1rem;color:#0f0;}/*!sc*/
.goaCnt p{color:#0f0;opacity:0.9;margin:0;}/*!sc*/
data-styled.g15[id="sc-jHswkR"]{content:"goaCnt,"}/*!sc*/
.gjOEAT{max-width:100%;height:auto;border:1px solid #0f0;box-shadow:0 0 15px rgba(0, 255, 0, 0.5);margin-bottom:1rem;}/*!sc*/
data-styled.g16[id="sc-cSaEAk"]{content:"gjOEAT,"}/*!sc*/
.hRjXcY{background:rgba(0, 255, 0, 0.1);padding:1rem;border:1px solid #0f0;position:relative;margin:1.5rem 0;}/*!sc*/
data-styled.g17[id="sc-jZTQcj"]{content:"hRjXcY,"}/*!sc*/
.bHcmTX{position:absolute;top:5px;right:5px;background:transparent;border:1px solid #0f0;color:#0f0;padding:0.3rem 0.5rem;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;gap:5px;}/*!sc*/
.bHcmTX:hover{background:#0f0;color:#000;}/*!sc*/
data-styled.g18[id="sc-dkBYrC"]{content:"bHcmTX,"}/*!sc*/
.eIsTfe{display:flex;justify-content:center;margin:1rem auto;text-align:center;}/*!sc*/
.eIsTfe img{max-width:100%;height:auto;border:1px solid #0f0;box-shadow:0 0 10px rgba(0, 255, 0, 0.3);}/*!sc*/
data-styled.g19[id="sc-kXOizl"]{content:"eIsTfe,"}/*!sc*/
</style></head><body><div id="root"><video autoPlay="" loop="" muted="" class="sc-cMqPwU jJIuNk"><source src="/outrun-waves_1.webm" type="video/webm"/></video><nav class="sc-FEMpB cMMXFN"><ul class="sc-gjcoXW kIaxle"><li class="sc-dVBluf iGNEod"><a href="/craigjmidwinter.github.io/blog/">BLOG HOME</a></li><li class="sc-dVBluf iGNEod"><a href="/craigjmidwinter.github.io">ABOUT CRAIG</a></li></ul></nav><div class="sc-jUkaYT hNzkKj"><div class="sc-jHswkR goaCnt"><p>2018-05-20</p><h1>Making my dumb bed, smart – Home Assistant Bed Occupancy Sensor</h1><img src="/assets/blog/IMG_20180518_174346.jpg" alt="Making my dumb bed, smart – Home Assistant Bed Occupancy Sensor" class="sc-cSaEAk gjOEAT"/></div><div class="sc-deSjom dYLfrY"><p><strong>Note:</strong> This blog is an archive. Some content may be out of date, and images may be broken or missing. If you find an issue or have a question, please email <strong>craig.j.midwinter@gmail.com</strong>.</p></div><p>I’ll try not to be as long-winded as I usually am, but I’m pretty proud of the bed sensor I built. Here’s a video of it working in Home Assistant:</p>
<p>Now, this sensor is similar to the one in <a href="http://24-7-home-security.com/how-to-make-a-wifi-bed-occupancy-sensor-arduino/">this build on the 24-7-home-security blog</a>, with a few changes– Instead of using the Arduino Uno for the controller, I used <a href="https://www.gearbest.com/transmitters-receivers-module/pp_366523.html?wid=1433363&amp;lkid=14192359">this ESP8266MOD dev board</a>. I chose this for a few reasons– it’s smaller, cheaper and it’s got wifi capabilities built in which eliminates the need for an additional ethernet/wifi shield and the router. I also chose to use one of <a href="https://www.amazon.ca/gp/product/B0753G1ZDZ/ref=oh_aui_detailpage_o02_s00?ie=UTF8&amp;psc=1">these little potentiometers</a> (I used a 1k) instead of the voltage divider in the blog post– it’s smaller and it’s what I had lying around.</p>
<p>I’ve got a king sized bed and I wanted to get a reading on both using two FSRs. The one drawback to the ESP8266MOD is that it only has a single analog input pin– this means, if you want to read the two separately, you’ll need to multiplex them, or build two sensors. I just ended up building two sensors.</p>
<p>Let’s take a look at the guts of this thing:</p>
<div class="sc-kXOizl eIsTfe"><img alt="" src="/assets/blog/IMG_20180518_174346.jpg"/></div>
<p>I thought I had taken more and better photos of this before I sealed it up and put it in place, but I guess I didn’t/ The strip thing you see goes on for 2 feet. That’s the FSR and it just sits underneath the mattress but on top of the box spring. In the final version, I made the wires that connect it to the controller much longer so that the controllers can just sit on the floor under the bed.</p>
<p>There’s not a heck of a lot to see in the Arduino sketch. Most of it I just patched together from pieces of code I found around the internet. All it does is connect to wifi, read the analog pin and then publish the value to my MQTT server.</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-c" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>    </span><span class="token token macro directive-hash" style="color:#72f1b8;text-shadow:0 0 2px #100c0f, 0 0 10px #257c5575, 0 0 35px #21272475">#</span><span class="token token macro directive" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">include</span><span class="token token macro" style="color:#72f1b8;text-shadow:0 0 2px #100c0f, 0 0 10px #257c5575, 0 0 35px #21272475"> </span><span>
</span><span>    </span><span class="token token macro directive-hash" style="color:#72f1b8;text-shadow:0 0 2px #100c0f, 0 0 10px #257c5575, 0 0 35px #21272475">#</span><span class="token token macro directive" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">include</span><span class="token token macro" style="color:#72f1b8;text-shadow:0 0 2px #100c0f, 0 0 10px #257c5575, 0 0 35px #21272475"> </span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">int</span><span> fsrAnalogPin </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#e2777a">0</span><span class="token token" style="color:#ccc">;</span><span> </span><span class="token token" style="color:#8e8e8e">// FSR is connected to analog 0</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">int</span><span> LEDpin </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#e2777a">11</span><span class="token token" style="color:#ccc">;</span><span> </span><span class="token token" style="color:#8e8e8e">// connect Red LED to pin 11 (PWM pin)</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">int</span><span> fsrReading</span><span class="token token" style="color:#ccc">;</span><span> </span><span class="token token" style="color:#8e8e8e">// the analog reading from the FSR resistor divider</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">int</span><span> LEDbrightness</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    WiFiClient espClient</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">const</span><span> </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">char</span><span> </span><span class="token token" style="color:#67cdcc">*</span><span> ssid </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f87c32">&quot;SSID&quot;</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">const</span><span> </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">char</span><span> </span><span class="token token" style="color:#67cdcc">*</span><span> password </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f87c32">&quot;PASSWORD&quot;</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    PubSubClient </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">client</span><span class="token token" style="color:#ccc">(</span><span>espClient</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">const</span><span> </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">char</span><span> </span><span class="token token" style="color:#67cdcc">*</span><span> mqtt_topic_bed </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f87c32">&quot;sensor/bed/left&quot;</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">const</span><span> </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">char</span><span> </span><span class="token token" style="color:#67cdcc">*</span><span> mqtt_server </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f87c32">&quot;mqtt.address&quot;</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">void</span><span> </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">loop</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>      </span><span class="token token" style="color:#8e8e8e">// put your main code here, to run repeatedly:</span><span>
</span><span>      fsrReading </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">analogRead</span><span class="token token" style="color:#ccc">(</span><span>fsrAnalogPin</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;Analog reading = &quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span>fsrReading</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">if</span><span> </span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#67cdcc">!</span><span>client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">connected</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>        </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">reconnect</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">}</span><span>
</span>      
<span>      </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">char</span><span> buffer</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#e2777a">10</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">dtostrf</span><span class="token token" style="color:#ccc">(</span><span>fsrReading</span><span class="token token" style="color:#ccc">,</span><span class="token token" style="color:#e2777a">0</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#e2777a">0</span><span class="token token" style="color:#ccc">,</span><span> buffer</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span>    
<span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span>buffer</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">publish</span><span class="token token" style="color:#ccc">(</span><span>mqtt_topic_bed</span><span class="token token" style="color:#ccc">,</span><span> buffer</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">delay</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#e2777a">1000</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">}</span><span>
</span>    
<span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">void</span><span> </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">setup</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">begin</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#e2777a">9600</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span> </span><span class="token token" style="color:#8e8e8e">// We&#x27;ll send debugging information via the Serial monitor</span><span>
</span><span>      </span><span class="token token" style="color:#8e8e8e">// setup WiFi</span><span>
</span><span>      </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">setup_wifi</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">setServer</span><span class="token token" style="color:#ccc">(</span><span>mqtt_server</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#e2777a">1883</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">reconnect</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">}</span><span>
</span>    
<span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">void</span><span> </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">reconnect</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>      </span><span class="token token" style="color:#8e8e8e">// Loop until we&#x27;re reconnected</span><span>
</span><span>      </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">while</span><span> </span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#67cdcc">!</span><span>client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">connected</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>        Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;Attempting MQTT connection...&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>        </span><span class="token token" style="color:#8e8e8e">// Attempt to connect</span><span>
</span><span>        </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">if</span><span> </span><span class="token token" style="color:#ccc">(</span><span>client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">connect</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;ESP8266Client&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#f87c32">&quot;USERNAME&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#f87c32">&quot;PASSWORD&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>        </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>          Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;connected&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>        </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>        </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">else</span><span>
</span><span>        </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>          Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;failed, rc=&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>          Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span>client</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">state</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>          Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot; try again in 5 seconds&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>          </span><span class="token token" style="color:#8e8e8e">// Wait 5 seconds before retrying</span><span>
</span><span>          </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">delay</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#e2777a">5000</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>        </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">}</span><span>
</span>    
<span>    </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">void</span><span> </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">setup_wifi</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>      </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">delay</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#e2777a">10</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#8e8e8e">// We start by connecting to a WiFi network</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;Connecting to &quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">println</span><span class="token token" style="color:#ccc">(</span><span>ssid</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      WiFi</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">begin</span><span class="token token" style="color:#ccc">(</span><span>ssid</span><span class="token token" style="color:#ccc">,</span><span> password</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">while</span><span> </span><span class="token token" style="color:#ccc">(</span><span>WiFi</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">status</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#67cdcc">!=</span><span> WL_CONNECTED</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>        </span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">delay</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#e2777a">500</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>        Serial</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#fdfdfd;text-shadow:0 0 2px #001716, 0 0 3px #03edf975, 0 0 5px #03edf975, 0 0 8px #03edf975">print</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f87c32">&quot;.&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">;</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">}</span></code></div></div></pre>
<p>Once it was in place and reporting I watched to see the values it was reporting while I wasn’t in bed compared to the values that it was reporting while I was in bed. The difference in the numbers was significant and finding a number to use as the threshold between the occupied and unoccupied states was really easy. Now, I just created these sensors within Home Assistant</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-yaml" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>    </span><span class="token token" style="color:#ccc">-</span><span> </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">platform</span><span class="token token" style="color:#ccc">:</span><span> mqtt
</span><span>      </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">state_topic</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&#x27;sensor/bed/left&#x27;</span><span>
</span><span>      </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&#x27;bed_left_value&#x27;</span><span>
</span>    
<span>    </span><span class="token token" style="color:#ccc">-</span><span> </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">platform</span><span class="token token" style="color:#ccc">:</span><span> mqtt
</span><span>      </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">state_topic</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&#x27;sensor/bed/right&#x27;</span><span>
</span><span>      </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&#x27;bed_right_value&#x27;</span><span>
</span>    
<span>    </span><span class="token token" style="color:#ccc">-</span><span> </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">platform</span><span class="token token" style="color:#ccc">:</span><span> template
</span><span>      </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">sensors</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">bed_craig</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">friendly_name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;Bed - Craig&quot;</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">value_template</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;{% if states.sensor.bed_left_value.state|int &gt; 200 %}Occupied{% else %}Unoccupied{% endif %}&quot;</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">icon_template</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;{% if states.sensor.bed_left_value.state|int &gt; 200 %}mdi:hotel{% else %}mdi:bed-empty{% endif %}&quot;</span><span>
</span>    
<span>        </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">bed_jess</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">friendly_name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;Bed - Jess&quot;</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">value_template</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;{% if states.sensor.bed_right_value.state|int &gt; 200 %}Occupied{% else %}Unoccupied{% endif %}&quot;</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">icon_template</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;{% if states.sensor.bed_right_value.state|int &gt; 200 %}mdi:hotel{% else %}mdi:bed-empty{% endif %}&quot;</span><span>
</span>    
<span>        </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">bed_both</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">friendly_name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;Bed - Both&quot;</span><span>
</span><span>          </span><span class="token token key" style="color:#f4eee4;text-shadow:0 0 2px #393a33, 0 0 8px #f39f0575, 0 0 2px #f39f0575">value_template</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f87c32">&quot;{% if states.sensor.bed_jess.state == &#x27;Occupied&#x27; and states.sensor.bed_craig.state == &#x27;Occupied&#x27; %}Occupied{% else %}Unoccupied{% endif %}&quot;</span></code></div></div></pre>
<p>Boom! That’s all there is to it! Right now, I’ve just got it set up so that if we are both in bed, it turns off all the lights in the house other than the ones in the bedroom and arms the alarm system, and then if one of us gets out of bed it will turn on the corridor and bathroom lights on a low brightness in case one of us gets up during the night. I’ll try to remember to post any unique automations I come up with that use this sensor. If you’ve got a bed sensor or anything similar, let me know what some of your favourite automations that make use of it are in the comments!</p></div></div><script src="/craigjmidwinter.github.io/_next/static/chunks/webpack-05a4c90833827c02.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[93812,[\"285\",\"static/chunks/285-46291424471f6717.js\",\"177\",\"static/chunks/app/layout-7d366822714c55bb.js\"],\"default\"]\n3:I[15244,[],\"\"]\n4:I[43866,[],\"\"]\n6:I[86213,[],\"OutletBoundary\"]\n8:I[86213,[],\"MetadataBoundary\"]\na:I[86213,[],\"ViewportBoundary\"]\nc:I[34835,[],\"\"]\n:HL[\"/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"-bacap1V3AiGvFOWYwHcm\",\"p\":\"/craigjmidwinter.github.io\",\"c\":[\"\",\"blog\",\"2018-05-making-my-dumb-bed-smart-home-assistant-bed-occupancy-sensor\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"2018-05-making-my-dumb-bed-smart-home-assistant-bed-occupancy-sensor\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.googleapis.com\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.gstatic.com\",\"crossOrigin\":\"\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Press+Start+2P\u0026display=swap\",\"rel\":\"stylesheet\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"div\",null,{\"id\":\"root\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"2018-05-making-my-dumb-bed-smart-home-assistant-bed-occupancy-sensor\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",null,[\"$\",\"$L6\",null,{\"children\":\"$L7\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"YHMhuBhLfNpTolrJsDr1l\",{\"children\":[[\"$\",\"$L8\",null,{\"children\":\"$L9\"}],[\"$\",\"$La\",null,{\"children\":\"$Lb\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$c\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"d:I[86880,[\"844\",\"static/chunks/ee560e2c-c5c28398d0153d35.js\",\"285\",\"static/chunks/285-46291424471f6717.js\",\"977\",\"static/chunks/977-4f350745d400d589.js\",\"173\",\"static/chunks/173-52b2b489d82616e2.js\",\"590\",\"static/chunks/590-97f4dc9b90039a27.js\",\"953\",\"static/chunks/app/blog/%5Bslug%5D/page-ac15a53f2a627631.js\"],\"default\"]\ne:T17f2,"])</script><script>self.__next_f.push([1,"\nI’ll try not to be as long-winded as I usually am, but I’m pretty proud of the bed sensor I built. Here’s a video of it working in Home Assistant:\n\nNow, this sensor is similar to the one in [this build on the 24-7-home-security blog](http://24-7-home-security.com/how-to-make-a-wifi-bed-occupancy-sensor-arduino/), with a few changes– Instead of using the Arduino Uno for the controller, I used [this ESP8266MOD dev board](https://www.gearbest.com/transmitters-receivers-module/pp_366523.html?wid=1433363\u0026amp;lkid=14192359). I chose this for a few reasons– it’s smaller, cheaper and it’s got wifi capabilities built in which eliminates the need for an additional ethernet/wifi shield and the router. I also chose to use one of [these little potentiometers](https://www.amazon.ca/gp/product/B0753G1ZDZ/ref=oh_aui_detailpage_o02_s00?ie=UTF8\u0026amp;psc=1) (I used a 1k) instead of the voltage divider in the blog post– it’s smaller and it’s what I had lying around.\n\nI’ve got a king sized bed and I wanted to get a reading on both using two FSRs. The one drawback to the ESP8266MOD is that it only has a single analog input pin– this means, if you want to read the two separately, you’ll need to multiplex them, or build two sensors. I just ended up building two sensors.\n\nLet’s take a look at the guts of this thing:\n\n![](/assets/blog/IMG_20180518_174346.jpg)\n\nI thought I had taken more and better photos of this before I sealed it up and put it in place, but I guess I didn’t/ The strip thing you see goes on for 2 feet. That’s the FSR and it just sits underneath the mattress but on top of the box spring. In the final version, I made the wires that connect it to the controller much longer so that the controllers can just sit on the floor under the bed.\n\nThere’s not a heck of a lot to see in the Arduino sketch. Most of it I just patched together from pieces of code I found around the internet. All it does is connect to wifi, read the analog pin and then publish the value to my MQTT server.\n\n```c\n    #include \n    #include \n    int fsrAnalogPin = 0; // FSR is connected to analog 0\n    int LEDpin = 11; // connect Red LED to pin 11 (PWM pin)\n    int fsrReading; // the analog reading from the FSR resistor divider\n    int LEDbrightness;\n    WiFiClient espClient;\n    const char * ssid = \"SSID\";\n    const char * password = \"PASSWORD\";\n    PubSubClient client(espClient);\n    const char * mqtt_topic_bed = \"sensor/bed/left\";\n    const char * mqtt_server = \"mqtt.address\";\n    void loop()\n    {\n      // put your main code here, to run repeatedly:\n      fsrReading = analogRead(fsrAnalogPin);\n      Serial.print(\"Analog reading = \");\n      Serial.println(fsrReading);\n      if (!client.connected())\n      {\n        reconnect();\n      }\n      \n      char buffer[10];\n      dtostrf(fsrReading,0, 0, buffer);\n    \n      Serial.println(buffer);\n      client.publish(mqtt_topic_bed, buffer);\n      delay(1000);\n    }\n    \n    void setup()\n    {\n      Serial.begin(9600); // We'll send debugging information via the Serial monitor\n      // setup WiFi\n      setup_wifi();\n      client.setServer(mqtt_server, 1883);\n      reconnect();\n    }\n    \n    void reconnect()\n    {\n      // Loop until we're reconnected\n      while (!client.connected())\n      {\n        Serial.print(\"Attempting MQTT connection...\");\n        // Attempt to connect\n        if (client.connect(\"ESP8266Client\", \"USERNAME\", \"PASSWORD\"))\n        {\n          Serial.println(\"connected\");\n        }\n        else\n        {\n          Serial.print(\"failed, rc=\");\n          Serial.print(client.state());\n          Serial.println(\" try again in 5 seconds\");\n          // Wait 5 seconds before retrying\n          delay(5000);\n        }\n      }\n    }\n    \n    void setup_wifi()\n    {\n      delay(10);\n      // We start by connecting to a WiFi network\n      Serial.println();\n      Serial.print(\"Connecting to \");\n      Serial.println(ssid);\n      WiFi.begin(ssid, password);\n      while (WiFi.status() != WL_CONNECTED)\n      {\n        delay(500);\n        Serial.print(\".\");\n      }\n    }\n```\n\nOnce it was in place and reporting I watched to see the values it was reporting while I wasn’t in bed compared to the values that it was reporting while I was in bed. The difference in the numbers was significant and finding a number to use as the threshold between the occupied and unoccupied states was really easy. Now, I just created these sensors within Home Assistant\n\n```yaml\n    - platform: mqtt\n      state_topic: 'sensor/bed/left'\n      name: 'bed_left_value'\n    \n    - platform: mqtt\n      state_topic: 'sensor/bed/right'\n      name: 'bed_right_value'\n    \n    - platform: template\n      sensors:\n        bed_craig:\n          friendly_name: \"Bed - Craig\"\n          value_template: \"{% if states.sensor.bed_left_value.state|int \u003e 200 %}Occupied{% else %}Unoccupied{% endif %}\"\n          icon_template: \"{% if states.sensor.bed_left_value.state|int \u003e 200 %}mdi:hotel{% else %}mdi:bed-empty{% endif %}\"\n    \n        bed_jess:\n          friendly_name: \"Bed - Jess\"\n          value_template: \"{% if states.sensor.bed_right_value.state|int \u003e 200 %}Occupied{% else %}Unoccupied{% endif %}\"\n          icon_template: \"{% if states.sensor.bed_right_value.state|int \u003e 200 %}mdi:hotel{% else %}mdi:bed-empty{% endif %}\"\n    \n        bed_both:\n          friendly_name: \"Bed - Both\"\n          value_template: \"{% if states.sensor.bed_jess.state == 'Occupied' and states.sensor.bed_craig.state == 'Occupied' %}Occupied{% else %}Unoccupied{% endif %}\"\n```\n\nBoom! That’s all there is to it! Right now, I’ve just got it set up so that if we are both in bed, it turns off all the lights in the house other than the ones in the bedroom and arms the alarm system, and then if one of us gets out of bed it will turn on the corridor and bathroom lights on a low brightness in case one of us gets up during the night. I’ll try to remember to post any unique automations I come up with that use this sensor. If you’ve got a bed sensor or anything similar, let me know what some of your favourite automations that make use of it are in the comments!\n"])</script><script>self.__next_f.push([1,"5:[\"$\",\"$Ld\",null,{\"post\":{\"slug\":\"2018-05-making-my-dumb-bed-smart-home-assistant-bed-occupancy-sensor\",\"title\":\"Making my dumb bed, smart – Home Assistant Bed Occupancy Sensor\",\"date_published\":\"$D2018-05-20T23:43:00.000Z\",\"date_updated\":\"$D2018-12-31T14:49:22.000Z\",\"tags\":\"Home Assistant, MQTT, NodeMCU, Arduino, Home Automation, Programming\",\"cover_image\":\"/assets/blog/IMG_20180518_174346.jpg\",\"content\":\"$e\"}}]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n9:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Craig Midwinter - Personal Website\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Welcome to my personal website. Check out my resume, GitHub, LinkedIn, podcast, and blog posts.\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/craigjmidwinter.github.io/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script><script>self.__next_f.push([1,"7:null\n"])</script></body></html>