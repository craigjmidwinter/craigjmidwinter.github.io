<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/craigjmidwinter.github.io/_next/static/chunks/webpack-05a4c90833827c02.js"/><script src="/craigjmidwinter.github.io/_next/static/chunks/4bd1b696-d31891ed15a5103e.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/517-2e9372f9ab95c04e.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/main-app-3b8a8eba0304deb0.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/285-46291424471f6717.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/app/layout-7d366822714c55bb.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/ee560e2c-c5c28398d0153d35.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/977-4f350745d400d589.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/173-52b2b489d82616e2.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/590-97f4dc9b90039a27.js" async=""></script><script src="/craigjmidwinter.github.io/_next/static/chunks/app/blog/%5Bslug%5D/page-ac15a53f2a627631.js" async=""></script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><title>Craig Midwinter - Personal Website</title><meta name="description" content="Welcome to my personal website. Check out my resume, GitHub, LinkedIn, podcast, and blog posts."/><link rel="icon" href="/craigjmidwinter.github.io/favicon.ico" type="image/x-icon" sizes="16x16"/><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet"/><script src="/craigjmidwinter.github.io/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script><style data-styled="" data-styled-version="6.1.15">.cMMXFN{background:rgba(0, 0, 20, 0.9);padding:1.5rem 2rem;border-bottom:2px solid #0ff;box-shadow:0 0 25px rgba(0, 255, 255, 0.3);position:relative;font-family:'Press Start 2P',monospace;backdrop-filter:blur(5px);}/*!sc*/
data-styled.g1[id="sc-FEMpB"]{content:"cMMXFN,"}/*!sc*/
.kIaxle{list-style:none;display:flex;gap:2rem;margin:0;padding:0;justify-content:center;}/*!sc*/
data-styled.g2[id="sc-gjcoXW"]{content:"kIaxle,"}/*!sc*/
.iGNEod{position:relative;}/*!sc*/
.iGNEod a{color:#0ff;text-decoration:none;padding:0.5rem 1rem;transition:all 0.3s ease;position:relative;}/*!sc*/
.iGNEod a:hover{color:#f0f;animation:cjwSKm 0.3s infinite;}/*!sc*/
.iGNEod a:hover::before{content:">";position:absolute;left:-1.2em;filter:drop-shadow(0 0 2px #f0f);}/*!sc*/
.iGNEod a:hover::after{content:"_";margin-left:0.5rem;}/*!sc*/
data-styled.g3[id="sc-dVBluf"]{content:"iGNEod,"}/*!sc*/
@keyframes cjwSKm{0%{text-shadow:2px 2px #0ff,-2px -2px #f0f;}25%{text-shadow:-2px 2px #0ff,2px -2px #f0f;}50%{text-shadow:2px -2px #0ff,-2px 2px #f0f;}75%{text-shadow:-2px -2px #0ff,2px 2px #f0f;}100%{text-shadow:2px 2px #0ff,-2px -2px #f0f;}}/*!sc*/
data-styled.g11[id="sc-keyframes-cjwSKm"]{content:"cjwSKm,"}/*!sc*/
.jJIuNk{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:-2;}/*!sc*/
data-styled.g12[id="sc-cMqPwU"]{content:"jJIuNk,"}/*!sc*/
.hNzkKj{max-width:800px;margin:2rem auto;padding:2rem;background:#000;color:#0f0;font-family:'IBM Plex Mono',monospace;line-height:1.6;border:2px solid #0f0;box-shadow:0 0 20px rgba(0, 255, 0, 0.5);position:relative;overflow:hidden;}/*!sc*/
data-styled.g13[id="sc-jUkaYT"]{content:"hNzkKj,"}/*!sc*/
.dYLfrY{background:rgba(0, 0, 0, 0.7);color:#ff0;border:1px solid #f0f;padding:1rem;margin-bottom:1rem;text-align:center;font-size:0.85rem;line-height:1.4;}/*!sc*/
.dYLfrY strong{color:#f0f;}/*!sc*/
data-styled.g14[id="sc-deSjom"]{content:"dYLfrY,"}/*!sc*/
.goaCnt{margin-bottom:1rem;}/*!sc*/
.goaCnt h1{font-size:1.5rem;margin-bottom:1rem;color:#0f0;}/*!sc*/
.goaCnt p{color:#0f0;opacity:0.9;margin:0;}/*!sc*/
data-styled.g15[id="sc-jHswkR"]{content:"goaCnt,"}/*!sc*/
.hRjXcY{background:rgba(0, 255, 0, 0.1);padding:1rem;border:1px solid #0f0;position:relative;margin:1.5rem 0;}/*!sc*/
data-styled.g17[id="sc-jZTQcj"]{content:"hRjXcY,"}/*!sc*/
.bHcmTX{position:absolute;top:5px;right:5px;background:transparent;border:1px solid #0f0;color:#0f0;padding:0.3rem 0.5rem;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;gap:5px;}/*!sc*/
.bHcmTX:hover{background:#0f0;color:#000;}/*!sc*/
data-styled.g18[id="sc-dkBYrC"]{content:"bHcmTX,"}/*!sc*/
</style></head><body><div id="root"><video autoPlay="" loop="" muted="" class="sc-cMqPwU jJIuNk"><source src="/outrun-waves_1.webm" type="video/webm"/></video><nav class="sc-FEMpB cMMXFN"><ul class="sc-gjcoXW kIaxle"><li class="sc-dVBluf iGNEod"><a href="/craigjmidwinter.github.io/blog/">BLOG HOME</a></li><li class="sc-dVBluf iGNEod"><a href="/craigjmidwinter.github.io">ABOUT CRAIG</a></li></ul></nav><div class="sc-jUkaYT hNzkKj"><div class="sc-jHswkR goaCnt"><p>2018-05-16</p><h1>Smart Garbage! – Pattern for deferring service calls in Home Assistant</h1></div><div class="sc-deSjom dYLfrY"><p><strong>Note:</strong> This blog is an archive. Some content may be out of date, and images may be broken or missing. If you find an issue or have a question, please email <strong>craig.j.midwinter@gmail.com</strong>.</p></div><p>Garbage day is the same day every week, but somehow I haven’t developed a steady routine surrounding it. Our garbage is picked up out front, but the main way we enter and leave the house is through the back door. As a result, I’ve got a bad habit of forgetting to put out the garbage and recycling. While I haven’t come up with a way to make the bins take themselves out, I’ve come out with a nice solution to remind me to take them out and bring them back in.</p>
<p>This is the first part in a series of posts about how I’ve implemented my Garbage reminders. I wanted to cover this automation, because while it’s a ridiculously unnecessary automation, I think some of the components and patterns in its implementation can be followed and used individually in really interesting ways. In this post, I’m going to focus on the pattern that I follow when I need to defer a service call within Home Assistant.</p>
<p>So, this automation started really simply. Since Garbage day is Friday, I just set a static reminder on Thursday evening to notify me to put the garbage out, and one on Friday after work to bring it back in. The automations for both are essentially the exact same just at a different time with different message text, so we’ll just look at the first one</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>- alias: &#x27;Garbage Day&#x27;
</span>  initial_state: &#x27;on&#x27;
<!-- -->  trigger:
<!-- -->    platform: time
<!-- -->    at: &#x27;20:15:00&#x27;
<!-- -->  condition:
<!-- -->  - condition: time
<!-- -->    weekday:
<!-- -->      - thu
<!-- -->  action:
<!-- -->  - service: notify.149twitter
<!-- -->    data:
<!-- -->      message: &quot;Tomorrow is garbage day @craigjmidwinter&quot;</code></div></div></pre>
<p>Ok, not bad, but it could be better. What if I’m not home? How about I defer these notifications until I get home when I can actually do something about it so that I don’t forget again?</p>
<p>We can easily make sure this doesn’t fire while we are away by adding a condition to our first automation so that it only fires when we are home–</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>- alias: &#x27;Garbage Day - Home&#x27;
</span>  initial_state: &#x27;on&#x27;
<!-- -->  trigger:
<!-- -->    platform: time
<!-- -->    at: &#x27;20:15:00&#x27;
<!-- -->  condition:
<!-- -->  - condition: time
<!-- -->    weekday:
<!-- -->      - thu
<!-- -->  - condition: state
<!-- -->    entity_id: device_tracker.craig_craig
<!-- -->    state: &#x27;home&#x27;
<!-- -->  action:
<!-- -->  - service: notify.149twitter
<!-- -->    data:
<!-- -->      message: &quot;Tomorrow is garbage day @craigjmidwinter&quot;</code></div></div></pre>
<p>But what happens if we are away when our reminder is supposed to fire while we’re out? We need an automation to handle that situation. It’s going to look very similar to the one for our home state.</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>- alias: &#x27;Garbage Day - Not Home&#x27;
</span>  initial_state: &#x27;on&#x27;
<!-- -->  trigger:
<!-- -->    platform: time
<!-- -->    at: &#x27;20:15:00&#x27;
<!-- -->  condition:
<!-- -->  - condition: time
<!-- -->    weekday:
<!-- -->      - thu
<!-- -->  - condition: template
<!-- -->    value_template: &quot;{{ not is_state(&#x27;device_tracker.craig_craig&#x27;, &#x27;home&#x27;) }}&quot;
<!-- -->  action:
<!-- -->  - service: input_boolean.turn_on
<!-- -->    entity_id: input_boolean.garbage_day_pending</code></div></div></pre>
<p>There are a couple of key differences in this automation. The first is the template condition that we added. I’ve decided to use a template condition here instead of a simple state condition that checks for not_home because I’ve got some zones set up, so this device tracking isn’t necessarily always in the not_home state when I’m out.</p>
<p>The second difference is that instead of calling the notification service, I’m turning on an input boolean that we need to add to our main configuration like this–</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>input_booleans:
</span>  garbage_day_pending:</code></div></div></pre>
<p>Perfect. Now we can create automations for our state change for when we arrive home, and use these being in the on state as a condition, and then in the action, we’ll trigger the service call we want to make, and then set our pending input boolean to off since the job is complete.</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>- alias: &#x27;Deferred Garbage Day Notification&#x27;
</span>  trigger:
<!-- -->    platform: state
<!-- -->    entity_id: device_tracker.craig_craig
<!-- -->    to: &#x27;home&#x27;
<!-- -->  condition:
<!-- -->  - condition: state
<!-- -->    entity_id: input_boolean.garbage_day_pending
<!-- -->    state: &#x27;on&#x27;
<!-- -->  action:
<!-- -->  - service: notify.149twitter
<!-- -->    data:
<!-- -->      message: &quot;Tomorrow is garbage day @craigjmidwinter&quot;
<!-- -->  - service: input_boolean.turn_off
<!-- -->    entity_id: input_boolean.garbage_day_pending</code></div></div></pre>
<p>Ok, great! But having these service calls duplicated sucks, what if we want to add on another notification platform like a facebook message or something? Then we’d need to make that change in more than one place, so lets move these to their own scripts and just call the scripts from both places. The scripts will look like this:</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>garbage_notify:
</span>  sequence:
<!-- -->    - service: notify.149twitter
<!-- -->      data:
<!-- -->        message: &quot;Tomorrow is garbage day @craigjmidwinter&quot;
<!-- -->    - service: notify.facebook
<!-- -->      data:
<!-- -->        message: &quot;Tomorrow is garbage day&quot;
<!-- -->        target:
<!-- -->          - !secret facebook_id_craig
<!-- -->          - !secret facebook_id_jess</code></div></div></pre>
<p>Then our complete, updated automations will look like this:</p>
<pre><div class="sc-jZTQcj hRjXcY"><button class="sc-dkBYrC bHcmTX"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg> Copy</button><div style="color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background-color:transparent !important;background-image:linear-gradient(to bottom, #2a2139 75%, #34294f)"><code class="language-text" style="white-space:pre;color:#f92aad;text-shadow:0 0 2px #100c0f, 0 0 5px #dc078e33, 0 0 10px #fff3;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>- alias: &#x27;Garbage Day - Home&#x27;
</span>  initial_state: &#x27;on&#x27;
<!-- -->  trigger:
<!-- -->    platform: time
<!-- -->    at: &#x27;20:15:00&#x27;
<!-- -->  condition:
<!-- -->  - condition: time
<!-- -->    weekday:
<!-- -->      - thu
<!-- -->  - condition: state
<!-- -->    entity_id: device_tracker.craig_craig
<!-- -->    state: &#x27;home&#x27;
<!-- -->  action:
<!-- -->  - service: script.turn_on
<!-- -->    entity_id: script.garbage_notify
<!-- -->
<!-- -->- alias: &#x27;Garbage Day - Not Home&#x27;
<!-- -->  initial_state: &#x27;on&#x27;
<!-- -->  trigger:
<!-- -->    platform: time
<!-- -->    at: &#x27;20:15:00&#x27;
<!-- -->  condition:
<!-- -->  - condition: time
<!-- -->    weekday:
<!-- -->      - thu
<!-- -->  - condition: template
<!-- -->    value_template: &quot;{{ not is_state(&#x27;device_tracker.craig_craig&#x27;, &#x27;home&#x27;) }}&quot;
<!-- -->  action:
<!-- -->  - service: input_boolean.turn_on
<!-- -->    entity_id: input_boolean.garbage_day_pending
<!-- -->
<!-- -->- alias: &#x27;Deferred Garbage Day Notification&#x27;
<!-- -->  trigger:
<!-- -->    platform: state
<!-- -->    entity_id: device_tracker.craig_craig
<!-- -->    to: &#x27;home&#x27;
<!-- -->  condition:
<!-- -->  - condition: state
<!-- -->    entity_id: input_boolean.garbage_day_pending
<!-- -->    state: &#x27;on&#x27;
<!-- -->  action:
<!-- -->  - service: script.turn_on
<!-- -->    entity_id: script.garbage_notify
<!-- -->  - service: input_boolean.turn_off
<!-- -->    entity_id: input_boolean.garbage_day_pending</code></div></div></pre>
<p>Fuck yeah! Now I’ll never forget to take the trash out ever again. This same pattern for deferring service calls is a super handy tool to use in order to add better context to notifications and automations.</p>
<p>It’s a small thing, but I personally find that it really helps make the house feel smarter– so much so that I’m considering writing a feature for Home Assistant to handle this sort of flow in a queue-worker system (for example, instead of having setting a switch, and then checking the switch when you get home to trigger the service call, you would just send the information about the service call to a ‘home’ queue and manage when the worker should be processing the jobs).</p>
<p>That’s it for part one! Stay tuned for part two where I’ll go over how I’m determining whether the garbage is at the curb already!</p></div></div><script src="/craigjmidwinter.github.io/_next/static/chunks/webpack-05a4c90833827c02.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[93812,[\"285\",\"static/chunks/285-46291424471f6717.js\",\"177\",\"static/chunks/app/layout-7d366822714c55bb.js\"],\"default\"]\n3:I[15244,[],\"\"]\n4:I[43866,[],\"\"]\n6:I[86213,[],\"OutletBoundary\"]\n8:I[86213,[],\"MetadataBoundary\"]\na:I[86213,[],\"ViewportBoundary\"]\nc:I[34835,[],\"\"]\n:HL[\"/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"-bacap1V3AiGvFOWYwHcm\",\"p\":\"/craigjmidwinter.github.io\",\"c\":[\"\",\"blog\",\"2018-05-smart-garbage-pt-1-pattern-for-deferring-service-calls-in-home-assistant\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"2018-05-smart-garbage-pt-1-pattern-for-deferring-service-calls-in-home-assistant\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/craigjmidwinter.github.io/_next/static/css/a2fe316cdd23b4ed.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.googleapis.com\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.gstatic.com\",\"crossOrigin\":\"\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Press+Start+2P\u0026display=swap\",\"rel\":\"stylesheet\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"div\",null,{\"id\":\"root\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"2018-05-smart-garbage-pt-1-pattern-for-deferring-service-calls-in-home-assistant\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",null,[\"$\",\"$L6\",null,{\"children\":\"$L7\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"uARrGzmXHZ1tmV9EmYUMn\",{\"children\":[[\"$\",\"$L8\",null,{\"children\":\"$L9\"}],[\"$\",\"$La\",null,{\"children\":\"$Lb\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$c\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"d:I[86880,[\"844\",\"static/chunks/ee560e2c-c5c28398d0153d35.js\",\"285\",\"static/chunks/285-46291424471f6717.js\",\"977\",\"static/chunks/977-4f350745d400d589.js\",\"173\",\"static/chunks/173-52b2b489d82616e2.js\",\"590\",\"static/chunks/590-97f4dc9b90039a27.js\",\"953\",\"static/chunks/app/blog/%5Bslug%5D/page-ac15a53f2a627631.js\"],\"default\"]\ne:T1bdc,"])</script><script>self.__next_f.push([1,"\nGarbage day is the same day every week, but somehow I haven’t developed a steady routine surrounding it. Our garbage is picked up out front, but the main way we enter and leave the house is through the back door. As a result, I’ve got a bad habit of forgetting to put out the garbage and recycling. While I haven’t come up with a way to make the bins take themselves out, I’ve come out with a nice solution to remind me to take them out and bring them back in.\n\nThis is the first part in a series of posts about how I’ve implemented my Garbage reminders. I wanted to cover this automation, because while it’s a ridiculously unnecessary automation, I think some of the components and patterns in its implementation can be followed and used individually in really interesting ways. In this post, I’m going to focus on the pattern that I follow when I need to defer a service call within Home Assistant.\n\nSo, this automation started really simply. Since Garbage day is Friday, I just set a static reminder on Thursday evening to notify me to put the garbage out, and one on Friday after work to bring it back in. The automations for both are essentially the exact same just at a different time with different message text, so we’ll just look at the first one\n\n    - alias: 'Garbage Day'\n      initial_state: 'on'\n      trigger:\n        platform: time\n        at: '20:15:00'\n      condition:\n      - condition: time\n        weekday:\n          - thu\n      action:\n      - service: notify.149twitter\n        data:\n          message: \"Tomorrow is garbage day @craigjmidwinter\"\n\nOk, not bad, but it could be better. What if I’m not home? How about I defer these notifications until I get home when I can actually do something about it so that I don’t forget again?\n\nWe can easily make sure this doesn’t fire while we are away by adding a condition to our first automation so that it only fires when we are home–\n\n    - alias: 'Garbage Day - Home'\n      initial_state: 'on'\n      trigger:\n        platform: time\n        at: '20:15:00'\n      condition:\n      - condition: time\n        weekday:\n          - thu\n      - condition: state\n        entity_id: device_tracker.craig_craig\n        state: 'home'\n      action:\n      - service: notify.149twitter\n        data:\n          message: \"Tomorrow is garbage day @craigjmidwinter\"\n\nBut what happens if we are away when our reminder is supposed to fire while we’re out? We need an automation to handle that situation. It’s going to look very similar to the one for our home state.\n\n    - alias: 'Garbage Day - Not Home'\n      initial_state: 'on'\n      trigger:\n        platform: time\n        at: '20:15:00'\n      condition:\n      - condition: time\n        weekday:\n          - thu\n      - condition: template\n        value_template: \"{{ not is_state('device_tracker.craig_craig', 'home') }}\"\n      action:\n      - service: input_boolean.turn_on\n        entity_id: input_boolean.garbage_day_pending\n\nThere are a couple of key differences in this automation. The first is the template condition that we added. I’ve decided to use a template condition here instead of a simple state condition that checks for not_home because I’ve got some zones set up, so this device tracking isn’t necessarily always in the not_home state when I’m out.\n\nThe second difference is that instead of calling the notification service, I’m turning on an input boolean that we need to add to our main configuration like this–\n\n    input_booleans:\n      garbage_day_pending:\n\nPerfect. Now we can create automations for our state change for when we arrive home, and use these being in the on state as a condition, and then in the action, we’ll trigger the service call we want to make, and then set our pending input boolean to off since the job is complete.\n\n    - alias: 'Deferred Garbage Day Notification'\n      trigger:\n        platform: state\n        entity_id: device_tracker.craig_craig\n        to: 'home'\n      condition:\n      - condition: state\n        entity_id: input_boolean.garbage_day_pending\n        state: 'on'\n      action:\n      - service: notify.149twitter\n        data:\n          message: \"Tomorrow is garbage day @craigjmidwinter\"\n      - service: input_boolean.turn_off\n        entity_id: input_boolean.garbage_day_pending\n\nOk, great! But having these service calls duplicated sucks, what if we want to add on another notification platform like a facebook message or something? Then we’d need to make that change in more than one place, so lets move these to their own scripts and just call the scripts from both places. The scripts will look like this:\n\n    garbage_notify:\n      sequence:\n        - service: notify.149twitter\n          data:\n            message: \"Tomorrow is garbage day @craigjmidwinter\"\n        - service: notify.facebook\n          data:\n            message: \"Tomorrow is garbage day\"\n            target:\n              - !secret facebook_id_craig\n              - !secret facebook_id_jess\n\nThen our complete, updated automations will look like this:\n\n    - alias: 'Garbage Day - Home'\n      initial_state: 'on'\n      trigger:\n        platform: time\n        at: '20:15:00'\n      condition:\n      - condition: time\n        weekday:\n          - thu\n      - condition: state\n        entity_id: device_tracker.craig_craig\n        state: 'home'\n      action:\n      - service: script.turn_on\n        entity_id: script.garbage_notify\n    \n    - alias: 'Garbage Day - Not Home'\n      initial_state: 'on'\n      trigger:\n        platform: time\n        at: '20:15:00'\n      condition:\n      - condition: time\n        weekday:\n          - thu\n      - condition: template\n        value_template: \"{{ not is_state('device_tracker.craig_craig', 'home') }}\"\n      action:\n      - service: input_boolean.turn_on\n        entity_id: input_boolean.garbage_day_pending\n    \n    - alias: 'Deferred Garbage Day Notification'\n      trigger:\n        platform: state\n        entity_id: device_tracker.craig_craig\n        to: 'home'\n      condition:\n      - condition: state\n        entity_id: input_boolean.garbage_day_pending\n        state: 'on'\n      action:\n      - service: script.turn_on\n        entity_id: script.garbage_notify\n      - service: input_boolean.turn_off\n        entity_id: input_boolean.garbage_day_pending\n\nFuck yeah! Now I’ll never forget to take the trash out ever again. This same pattern for deferring service calls is a super handy tool to use in order to add better context to notifications and automations.\n\nIt’s a small thing, but I personally find that it really helps make the house feel smarter– so much so that I’m considering writing a feature for Home Assistant to handle this sort of flow in a queue-worker system (for example, instead of having setting a switch, and then checking the switch when you get home to trigger the service call, you would just send the information about the service call to a ‘home’ queue and manage when the worker should be processing the jobs).\n\nThat’s it for part one! Stay tuned for part two where I’ll go over how I’m determining whether the garbage is at the curb already!\n"])</script><script>self.__next_f.push([1,"5:[\"$\",\"$Ld\",null,{\"post\":{\"slug\":\"2018-05-smart-garbage-pt-1-pattern-for-deferring-service-calls-in-home-assistant\",\"title\":\"Smart Garbage! – Pattern for deferring service calls in Home Assistant\",\"date_published\":\"$D2018-05-16T23:27:00.000Z\",\"date_updated\":\"$D2018-12-31T14:49:50.000Z\",\"tags\":\"Home Assistant, Home Automation, YAML, Design Patterns\",\"cover_image\":\"\",\"content\":\"$e\"}}]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n9:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Craig Midwinter - Personal Website\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Welcome to my personal website. Check out my resume, GitHub, LinkedIn, podcast, and blog posts.\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/craigjmidwinter.github.io/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script><script>self.__next_f.push([1,"7:null\n"])</script></body></html>